<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BookFinder</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Montserrat:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      /* CSS Variables for Theme Management */
      :root {
        /* Dark Theme Defaults (Deep Blue-Purple with Gold Accents) */
        --bg-gradient-start: #1a1a2e;
        /* Darker blue-purple */
        --bg-gradient-mid: #0f0f1b;
        /* Very dark, almost black blue-purple */
        --bg-gradient-end: #0a0a16;
        /* Deepest midnight blue */

        --text-color-primary: #e0e0e0;
        /* Light Gray */
        --text-color-secondary: #b0b0b0;
        /* Muted Gray */
        --glass-bg-opacity: 0.08;
        --glass-border-opacity: 0.12;
        --glass-shadow-color: rgba(0, 0, 0, 0.4);
        --glass-blur: 20px;

        --navbar-bg-opacity: 0.5;
        --navbar-blur: 22px;

        --heading-color: #ffd700;
        /* Gold */
        --heading-shadow-color: rgba(255, 215, 0, 0.5);
        --accent-color: #ffd700;
        /* Gold */
        --accent-shadow-color: rgba(255, 215, 0, 0.6);

        --card-hover-shadow-color: rgba(255, 215, 0, 0.4);
        --badge-bg-opacity: 0.6;
        --badge-text-color: #333;
        /* Dark text on badges */
        --input-bg-opacity: 0.1;
        --input-border-opacity: 0.2;
        --input-placeholder-color: rgba(224, 224, 224, 0.7);

        --modal-bg-opacity: 0.98;
        --modal-blur: 25px;
        --modal-border-opacity: 0.15;

        --scrollbar-track-bg: rgba(255, 255, 255, 0.05);
        --scrollbar-thumb-gradient-start: #ffd700;
        --scrollbar-thumb-gradient-end: #e6c200;

        --star-unfilled-color: rgba(255, 255, 255, 0.3);
        --spinner-color: #ffd700;
      }

      /* Light Theme Overrides (Warm Creams and Subtle Gold Hints) */
      :root.light-theme {
        --bg-gradient-start: #f9f5ee;
        /* Soft off-white/cream */
        --bg-gradient-mid: #f0ead6;
        /* Light parchment/sandy tone */
        --bg-gradient-end: #e6dcdc;
        /* Very light, muted rose/grey-ish */

        --text-color-primary: #333333;
        /* Dark Gray */
        --text-color-secondary: #555555;
        /* Medium Gray */
        --glass-bg-opacity: 0.7;
        --glass-border-opacity: 0.25;
        --glass-shadow-color: rgba(0, 0, 0, 0.12);
        --glass-blur: 10px;

        --navbar-bg-opacity: 0.9;
        --navbar-blur: 12px;

        --heading-color: #a0522d;
        /* Sienna (Earthy Brown) */
        --heading-shadow-color: rgba(160, 82, 45, 0.3);
        --accent-color: #d2b48c;
        /* Tan (Warm, muted gold) */
        --accent-shadow-color: rgba(210, 180, 140, 0.4);

        --card-hover-shadow-color: rgba(210, 180, 140, 0.5);
        --badge-bg-opacity: 0.8;
        --badge-text-color: #fff;
        /* White text on badges for better contrast */
        --input-bg-opacity: 0.95;
        --input-border-opacity: 0.35;
        --input-placeholder-color: rgba(51, 51, 51, 0.8);

        --modal-bg-opacity: 0.99;
        --modal-blur: 12px;
        --modal-border-opacity: 0.25;

        --scrollbar-track-bg: rgba(0, 0, 0, 0.08);
        --scrollbar-thumb-gradient-start: #d2b48c;
        --scrollbar-thumb-gradient-end: #b8860b;

        --star-unfilled-color: rgba(0, 0, 0, 0.4);
        --spinner-color: #daa520;
        /* Darker gold for light theme spinner */
      }

      /* Base Body and Font */
      body {
        background: linear-gradient(
          135deg,
          var(--bg-gradient-start),
          var(--bg-gradient-mid),
          var(--bg-gradient-end)
        );
        font-family: "Montserrat", sans-serif;
        color: var(--text-color-primary);
        overflow-x: hidden;
        min-height: 100vh;
        position: relative;
        transition: background 0.8s ease-in-out, color 0.8s ease-in-out;
        cursor: none;
        /* Hide default cursor */
      }

      /* --- Custom Cursor (The Light Trail) --- */
      .cursor-light-trail {
        position: fixed;
        pointer-events: none;
        width: 25px;
        /* Size of the glowing particle */
        height: 25px;
        background: radial-gradient(
          circle,
          var(--accent-color) 0%,
          rgba(255, 215, 0, 0) 70%
        );
        border-radius: 50%;
        transform: translate(-50%, -50%);
        /* Center the light */
        transition: transform 0.1s ease-out, opacity 0.5s ease-out;
        filter: blur(5px);
        /* Creates a soft glow */
        opacity: 0.8;
        z-index: 9999;
        /* Ensure it's on top */
      }

      /* Sophisticated Glassmorphism Base */
      .glass-effect {
        background: rgba(255, 255, 255, var(--glass-bg-opacity));
        border-radius: 20px;
        box-shadow: 0 8px 30px var(--glass-shadow-color);
        backdrop-filter: blur(var(--glass-blur));
        -webkit-backdrop-filter: blur(var(--glass-blur));
        border: 1px solid rgba(255, 255, 255, var(--glass-border-opacity));
        transition: all 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
        position: relative;
        overflow: hidden;
      }

      /* Subtle Glow/Highlight for Headings and Important Text */
      .classy-glow {
        font-family: "Playfair Display", serif;
        color: var(--heading-color);
        text-shadow: 0 0 10px var(--heading-shadow-color),
          0 0 20px rgba(255, 248, 225, 0.1);
        transition: text-shadow 0.4s ease-in-out, color 0.4s ease-in-out;
      }

      .classy-glow:hover {
        text-shadow: 0 0 15px var(--heading-shadow-color),
          0 0 25px rgba(255, 248, 225, 0.3);
      }

      /* --- Navbar --- */
      .navbar {
        background: rgba(0, 0, 0, var(--navbar-bg-opacity)) !important;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(var(--navbar-blur));
        -webkit-backdrop-filter: blur(var(--navbar-blur));
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        transition: background 0.8s ease-in-out,
          backdrop-filter 0.8s ease-in-out;
      }

      .navbar-brand {
        font-family: "Playfair Display", serif;
        font-weight: 700;
        font-size: 1.8rem;
        color: var(--accent-color) !important;
        text-shadow: 0 0 10px var(--accent-shadow-color);
        transition: all 0.3s ease;
      }

      .navbar-brand:hover {
        transform: scale(1.02);
        text-shadow: 0 0 15px var(--accent-shadow-color);
      }

      .nav-link {
        font-weight: 500;
        color: var(--text-color-secondary) !important;
        transition: all 0.3s ease;
        position: relative;
        font-size: 1.05rem;
        padding: 0.5rem 1.2rem;
      }

      .nav-link:hover,
      .nav-link.active {
        color: var(--accent-color) !important;
        transform: translateY(-3px);
        text-shadow: 0 0 5px var(--accent-shadow-color);
      }

      .nav-link::after {
        content: "";
        position: absolute;
        left: 50%;
        bottom: 2px;
        width: 0;
        height: 2px;
        background-color: var(--accent-color);
        transition: width 0.3s ease-out, left 0.3s ease-out,
          background-color 0.3s ease-out;
        border-radius: 1px;
      }

      .nav-link:hover::after,
      .nav-link.active::after {
        width: calc(100% - 20px);
        left: 10px;
      }

      /* Theme Toggle Switch */
      .theme-switch-wrapper {
        display: flex;
        align-items: center;
        margin-left: 20px;
      }

      .theme-switch {
        display: inline-block;
        height: 28px;
        position: relative;
        width: 50px;
      }

      .theme-switch input {
        display: none;
      }

      .slider {
        background-color: var(--text-color-secondary);
        bottom: 0;
        cursor: pointer;
        left: 0;
        position: absolute;
        right: 0;
        top: 0;
        transition: 0.4s;
        border-radius: 34px;
      }

      .slider:before {
        background-color: var(--accent-color);
        bottom: 4px;
        content: "";
        height: 20px;
        left: 4px;
        position: absolute;
        width: 20px;
        transition: 0.4s;
        border-radius: 50%;
      }

      input:checked + .slider {
        background-color: var(--accent-color);
      }

      input:checked + .slider:before {
        transform: translateX(22px);
        background-color: var(--text-color-primary);
        /* Invert color for knob */
      }

      .theme-switch-wrapper .bi {
        font-size: 1.2rem;
        color: var(--text-color-secondary);
        margin: 0 8px;
        transition: color 0.4s ease;
      }

      .theme-switch-wrapper .bi-moon-fill.active {
        color: var(--accent-color);
      }

      .theme-switch-wrapper .bi-sun-fill.active {
        color: var(--accent-color);
      }

      /* --- Main Content --- */
      main {
        padding-top: 120px;
      }

      section {
        padding: 50px;
        margin-bottom: 40px;
      }

      h1,
      h2,
      h3 {
        font-family: "Playfair Display", serif;
        font-weight: 700;
        margin-bottom: 30px;
      }

      .card {
        border: none;
        overflow: hidden;
        background: rgba(255, 255, 255, var(--glass-bg-opacity));
        box-shadow: 0 6px 25px var(--glass-shadow-color);
        backdrop-filter: blur(var(--glass-blur));
        -webkit-backdrop-filter: blur(var(--glass-blur));
        border: 1px solid rgba(255, 255, 255, var(--glass-border-opacity));
        transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1),
          box-shadow 0.4s cubic-bezier(0.25, 0.8, 0.25, 1),
          background 0.4s ease-in-out;
        will-change: transform, box-shadow;
        /* Optimize animations */
      }

      .card:hover {
        transform: translateY(-10px) scale(1.01);
        box-shadow: 0 15px 50px var(--glass-shadow-color),
          0 0 25px var(--card-hover-shadow-color);
      }

      .card-body {
        color: var(--text-color-primary);
        position: relative;
      }

      .book-cover {
        height: 220px;
        object-fit: contain;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        filter: brightness(0.9);
        transition: filter 0.3s ease;
      }

      .book-card:hover .book-cover {
        filter: brightness(1.1);
      }

      .book-title {
        font-family: "Playfair Display", serif;
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--accent-color);
        text-shadow: 0 0 5px var(--accent-shadow-color);
      }

      .book-authors {
        font-size: 0.95rem;
        color: var(--text-color-secondary);
      }

      .reading-status .badge {
        font-weight: 500;
        padding: 0.4em 0.8em;
        border-radius: 8px;
        background-color: rgba(255, 215, 0, var(--badge-bg-opacity)) !important;
        /* Gold tone for status */
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(5px);
        color: var(--badge-text-color);
        transition: background-color 0.4s ease, color 0.4s ease;
      }

      .reading-status .badge.bg-success {
        background-color: rgba(
          60,
          179,
          113,
          var(--badge-bg-opacity)
        ) !important;
      }

      /* Book progress bar */
      .book-progress {
        height: 10px;
        margin-top: 12px;
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 5px;
      }

      .book-progress .progress-bar {
        background-color: var(--accent-color);
        transition: width 0.4s ease, background-color 0.4s ease;
      }

      /* Gamified Progress Bar */
      .gamified-progress-bar {
        height: 15px;
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        margin-top: 15px;
        overflow: hidden;
        position: relative;
      }

      .gamified-progress-bar .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--accent-color), #ffec8b);
        /* Yellow to lighter yellow */
        border-radius: 8px;
        transition: width 0.6s ease-out;
        position: relative;
        box-shadow: 0 0 8px var(--accent-shadow-color);
      }

      .gamified-progress-bar .progress-fill::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: repeating-linear-gradient(
          -45deg,
          rgba(255, 255, 255, 0.1),
          rgba(255, 255, 255, 0.1) 5px,
          transparent 5px,
          transparent 10px
        );
        animation: progress-stripes 2s linear infinite;
        opacity: 0.3;
      }

      .custom-select-wrapper {
        width: 230px;
        position: relative;
      }

      /* Glassmorphic Select Bar */
      .stylish-select {
        padding-left: 2.5rem;
        padding-right: 3rem;
        background: rgba(255, 255, 255, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.25);
        border-radius: 999px;
        backdrop-filter: blur(10px);
        color: var(--text-color-primary, #222);
        font-weight: 500;
        height: 40px;
        appearance: none;
        transition: all 0.3s ease;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg width='16' height='16' fill='%23333' viewBox='0 0 16 16'%3E%3Cpath d='M1.5 5.5l6 6 6-6'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 1rem center;
        background-size: 12px;
      }

      /* Dark Mode Support */
      body.dark .stylish-select {
        background: rgba(255, 255, 255, 0.07);
        border-color: rgba(255, 255, 255, 0.15);
        background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg width='16' height='16' fill='%23f0f0f0' viewBox='0 0 16 16'%3E%3Cpath d='M1.5 5.5l6 6 6-6'/%3E%3C/svg%3E");
        color: #f0f0f0;
      }

      /* Select Focus Style */
      .stylish-select:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(90, 103, 216, 0.25);
        border-color: rgba(90, 103, 216, 0.4);
      }

      /* Icon Inside */
      .custom-icon {
        position: absolute;
        top: 50%;
        left: 16px;
        transform: translateY(-50%);
        font-size: 18px;
        color: var(--text-color-primary, #333);
        pointer-events: none;
        z-index: 2;
      }

      /* Optional: Rounded dropdown (Firefox, Edge, Safari) */
      .stylish-select option {
        background-color: rgba(255, 255, 255, 0.9);
        color: #222;
        font-weight: 500;
        border-radius: 8px;
        margin: 5px;
        padding: 10px;
      }

      /* Dark Mode Options */
      body.dark .stylish-select option {
        background-color: #1e1e2f;
        color: #eee;
      }

      @keyframes progress-stripes {
        from {
          background-position: 0 0;
        }

        to {
          background-position: 40px 0;
        }
      }

      /* Star rating */
      .star-rating {
        font-size: 1.6rem;
        color: var(--accent-color);
        margin-top: 12px;
      }

      .star-rating .bi-star-fill,
      .star-rating .bi-star {
        cursor: pointer;
        transition: color 0.2s ease, transform 0.1s ease;
      }

      .star-rating .bi-star {
        color: var(--star-unfilled-color);
      }

      .star-rating .bi-star-fill:hover,
      .star-rating .bi-star:hover {
        color: var(--accent-color);
        /* Still accent color on hover */
        transform: scale(1.1);
      }

      /* --- Search Input & Buttons --- */
      .input-group.rounded-pill .form-control,
      .input-group.rounded-pill .form-select:not(.modern-unique) {
        /* Exclude modern-unique from this rule */
        background: rgba(255, 255, 255, var(--input-bg-opacity));
        border: 1px solid rgba(255, 255, 255, var(--input-border-opacity));
        color: var(--text-color-primary);
        padding: 0.8rem 1.5rem;
        transition: background 0.4s ease, border-color 0.4s ease,
          color 0.4s ease;
      }

      .input-group.rounded-pill .form-control::placeholder {
        color: var(--input-placeholder-color);
      }

      .input-group.rounded-pill .form-select:not(.modern-unique) option {
        /* Exclude modern-unique from this rule */
        background-color: var(--bg-gradient-end);
        /* Use end gradient color for options */
        color: var(--text-color-primary);
      }

      .input-group.rounded-pill .form-control:focus,
      .input-group.rounded-pill .form-select:not(.modern-unique):focus {
        /* Exclude modern-unique from this rule */
        box-shadow: 0 0 0 0.25rem var(--accent-shadow-color);
        border-color: var(--accent-color);
      }

      /* Custom Dropdown Styling for libraryFilter (modern-unique) */
      .custom-select-wrapper {
        position: relative;
        display: inline-block;
        width: auto;
        vertical-align: middle;
        flex-grow: 1;
      }

      .form-select.modern-unique {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background: rgba(255, 255, 255, var(--input-bg-opacity));
        border: 1px solid rgba(255, 255, 255, var(--input-border-opacity));
        color: var(--text-color-primary);
        padding: 0.8rem 2.5rem 0.8rem 1.5rem;
        border-radius: 12px;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        width: 100%;
      }

      .form-select.modern-unique:hover {
        border-color: var(--accent-color);
        box-shadow: 0 6px 20px var(--accent-shadow-color);
        background: rgba(255, 255, 255, calc(var(--input-bg-opacity) + 0.05));
      }

      .form-select.modern-unique:focus {
        outline: none;
        box-shadow: 0 0 0 0.25rem var(--accent-shadow-color);
        border-color: var(--accent-color);
      }

      /* Custom arrow for the select */
      .custom-select-wrapper::after {
        content: "\F282";
        /* Bootstrap icon chevron-expand */
        font-family: "bootstrap-icons";
        position: absolute;
        right: 1.2rem;
        top: 50%;
        transform: translateY(-50%);
        pointer-events: none;
        color: var(--text-color-secondary);
        font-size: 0.9rem;
        transition: color 0.3s ease;
      }

      .form-select.modern-unique:hover + .custom-select-wrapper::after {
        color: var(--accent-color);
      }

      /* Style for options within the select */
      .form-select.modern-unique option {
        background-color: var(--bg-gradient-end);
        /* Use background end color */
        color: var(--text-color-primary);
        padding: 10px 15px;
      }

      .btn-primary {
        background-color: var(--accent-color);
        border-color: var(--accent-color);
        color: var(--badge-text-color);
        font-weight: 600;
        padding: 0.8rem 2rem;
        border-radius: 10px;
        box-shadow: 0 0 15px var(--accent-shadow-color);
        transition: all 0.3s ease, background-color 0.4s ease,
          border-color 0.4s ease, color 0.4s ease;
        position: relative;
        /* For achievement spark */
        overflow: hidden;
        /* For achievement spark */
      }

      .btn-primary:hover {
        background-color: var(--accent-color);
        filter: brightness(0.9);
        border-color: var(--accent-color);
        box-shadow: 0 0 20px var(--accent-shadow-color);
        transform: translateY(-4px);
      }

      /* Achievement spark on button click */
      .btn-primary.achievement-spark::after {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        background: radial-gradient(
          circle,
          #ffeb3b 0%,
          rgba(255, 235, 59, 0) 70%
        );
        border-radius: 50%;
        transform: translate(-50%, -50%);
        animation: spark-burst 0.7s forwards;
        opacity: 0;
      }

      @keyframes spark-burst {
        0% {
          width: 0;
          height: 0;
          opacity: 0;
        }

        50% {
          width: 100px;
          height: 100px;
          opacity: 1;
          filter: blur(5px);
        }

        100% {
          width: 150px;
          height: 150px;
          opacity: 0;
          filter: blur(10px);
        }
      }

      .btn-outline-primary {
        color: var(--accent-color);
        border-color: var(--accent-color);
        background: rgba(255, 215, 0, 0.1);
        transition: all 0.3s ease, color 0.4s ease, border-color 0.4s ease,
          background-color 0.4s ease;
        border-radius: 8px;
      }

      .btn-outline-primary:hover {
        background-color: var(--accent-color);
        color: var(--badge-text-color);
        transform: scale(1.05);
        box-shadow: 0 0 12px var(--accent-shadow-color);
      }

      .btn-outline-secondary {
        color: var(--text-color-secondary);
        border-color: var(--text-color-secondary);
        background: rgba(176, 176, 176, 0.1);
        transition: all 0.3s ease, color 0.4s ease, border-color 0.4s ease,
          background-color 0.4s ease;
        border-radius: 8px;
      }

      .btn-outline-secondary:hover {
        background-color: var(--text-color-secondary);
        color: var(--bg-gradient-start);
        transform: scale(1.05);
        box-shadow: 0 0 12px rgba(176, 176, 176, 0.4);
      }

      .btn-outline-danger {
        color: #e74c3c;
        border-color: #e74c3c;
        background: rgba(231, 76, 60, 0.1);
        transition: all 0.3s ease;
        border-radius: 8px;
      }

      .btn-outline-danger:hover {
        background-color: #e74c3c;
        color: #fff;
        transform: scale(1.05);
        box-shadow: 0 0 12px rgba(231, 76, 60, 0.6);
      }

      .spinner-border {
        color: var(--spinner-color) !important;
      }

      .text-muted {
        color: var(--text-color-secondary) !important;
      }

      /* --- Modal --- */
      .modal-content {
        background: rgba(26, 26, 46, var(--modal-bg-opacity));
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(var(--modal-blur));
        -webkit-backdrop-filter: blur(var(--modal-blur));
        border: 1px solid rgba(255, 255, 255, var(--modal-border-opacity));
        color: var(--text-color-primary);
        border-radius: 25px;
        transition: background 0.8s ease-in-out,
          backdrop-filter 0.8s ease-in-out, border-color 0.8s ease-in-out,
          color 0.8s ease-in-out;
      }

      .modal-header .btn-close {
        filter: brightness(0) invert(1);
        transition: transform 0.2s ease, filter 0.4s ease;
      }

      .modal-header .btn-close:hover {
        transform: scale(1.2);
      }

      .modal-title {
        font-family: "Playfair Display", serif;
        color: var(--accent-color);
        text-shadow: 0 0 8px var(--accent-shadow-color);
      }

      .modal-body .text-muted,
      .modal-body .text-secondary {
        color: var(--text-color-secondary) !important;
      }

      #modalBookCover {
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border-radius: 12px;
      }

      #modalBookCover:hover {
        transform: scale(1.03);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
      }

      /* --- Specific styling for the dropdown inside the modal --- */
      .modal-body .custom-select-wrapper {
        /* Ensure the wrapper also adjusts */
        width: 100%;
        /* Make wrapper take full width */
        flex-grow: unset;
        /* Remove flex-grow from custom-select-wrapper if it interferes */
      }

      .modal-body .form-select#readingStatus {
        -webkit-appearance: none;
        /* Remove default arrow for custom arrow */
        -moz-appearance: none;
        appearance: none;
        background: rgba(255, 255, 255, var(--input-bg-opacity));
        /* Use input glass bg */
        border: 1px solid rgba(255, 255, 255, var(--input-border-opacity));
        /* Use input glass border */
        color: var(--text-color-primary);
        padding: 0.75rem 1.25rem;
        /* Adjusted padding for better fit */
        border-radius: 12px;
        /* Consistent rounded corners */
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        position: relative;
        /* For custom arrow positioning */
        background-image: none;
        /* Ensure no default bootstrap arrow */
      }

      .modal-body .form-select#readingStatus:hover {
        border-color: var(--accent-color);
        box-shadow: 0 6px 20px var(--accent-shadow-color);
        background: rgba(255, 255, 255, calc(var(--input-bg-opacity) + 0.05));
      }

      .modal-body .form-select#readingStatus:focus {
        outline: none;
        box-shadow: 0 0 0 0.25rem var(--accent-shadow-color);
        border-color: var(--accent-color);
      }

      /* Custom arrow for the modal select */
      .modal-body .custom-select-wrapper .select-arrow {
        content: "\F282";
        /* Bootstrap icon chevron-expand */
        font-family: "bootstrap-icons";
        position: absolute;
        right: 1rem;
        /* Adjust position */
        top: 50%;
        transform: translateY(-50%);
        pointer-events: none;
        color: var(--text-color-secondary);
        font-size: 0.9rem;
        transition: color 0.3s ease;
      }

      /* Style for options within the modal select */
      .modal-body .form-select#readingStatus option {
        background-color: var(--bg-gradient-end);
        /* Consistent background for dropdown options */
        color: var(--text-color-primary);
        padding: 10px 15px;
        /* Add padding to options */
      }

      /* Ensure placeholder and range input are also themed */
      .modal-body .form-label {
        color: var(--text-color-secondary);
        /* Text color for labels */
      }

      .modal-body .form-range {
        -webkit-appearance: none;
        width: 100%;
        height: 8px;
        /* Thinner range track */
        background: rgba(255, 255, 255, var(--input-bg-opacity));
        /* Track background */
        border-radius: 5px;
        outline: none;
        transition: background 0.3s ease;
      }

      .modal-body .form-range::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--accent-color);
        /* Thumb color */
        cursor: pointer;
        box-shadow: 0 0 5px var(--accent-shadow-color);
        margin-top: -6px;
        /* Center thumb vertically */
        transition: background 0.3s ease, box-shadow 0.3s ease;
      }

      .modal-body .form-range::-moz-range-thumb {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--accent-color);
        cursor: pointer;
        box-shadow: 0 0 5px var(--accent-shadow-color);
        transition: background 0.3s ease, box-shadow 0.3s ease;
      }

      .modal-body .form-range::-webkit-slider-thumb:hover,
      .modal-body .form-range::-moz-range-thumb:hover {
        background: filter(brightness(1.1));
        /* Slightly brighter on hover */
        box-shadow: 0 0 8px var(--accent-shadow-color);
      }

      /* Star rating inside modal */
      .modal-body .star-rating {
        font-size: 1.8rem;
        /* Slightly larger stars in modal */
      }

      .modal-body .star-rating .bi-star-fill,
      .modal-body .star-rating .bi-star {
        margin: 0 3px;
        /* Space between stars */
      }

      /* --- Pseudo-elements for background effects --- */
      body::before,
      body::after {
        content: "";
        position: fixed;
        background: radial-gradient(
          circle,
          var(--accent-color) 0%,
          rgba(255, 215, 0, 0) 70%
        );
        /* Gold radial glow */
        border-radius: 50%;
        filter: blur(100px);
        opacity: 0.5;
        z-index: -1;
        animation: pulseGlow 18s infinite alternate ease-in-out;
        transition: background 0.8s ease-in-out;
        /* Smooth transition for glow color */
      }

      body::before {
        width: 400px;
        height: 400px;
        top: -100px;
        left: -100px;
        animation: moveGlow1 20s infinite alternate ease-in-out;
      }

      body::after {
        width: 500px;
        height: 500px;
        bottom: -150px;
        right: -150px;
        background: radial-gradient(
          circle,
          var(--heading-color) 0%,
          rgba(255, 248, 225, 0) 70%
        );
        /* Creamy radial glow */
        animation: moveGlow2 22s infinite alternate-reverse ease-in-out;
      }

      @keyframes moveGlow1 {
        0% {
          transform: translate(0, 0);
        }

        50% {
          transform: translate(60vw, 70vh);
        }

        100% {
          transform: translate(0, 0);
        }
      }

      @keyframes moveGlow2 {
        0% {
          transform: translate(0, 0);
        }

        50% {
          transform: translate(-70vw, -60vh);
        }

        100% {
          transform: translate(0, 0);
        }
      }

      @keyframes pulseGlow {
        0% {
          transform: scale(1);
          opacity: 0.5;
        }

        50% {
          transform: scale(1.05);
          opacity: 0.6;
        }

        100% {
          transform: scale(1);
          opacity: 0.5;
        }
      }

      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 10px;
      }

      ::-webkit-scrollbar-track {
        background: var(--scrollbar-track-bg);
        border-radius: 10px;
        transition: background 0.4s ease;
      }

      ::-webkit-scrollbar-thumb {
        background: linear-gradient(
          to bottom,
          var(--scrollbar-thumb-gradient-start),
          var(--scrollbar-thumb-gradient-end)
        );
        border-radius: 10px;
        transition: background 0.4s ease;
      }

      ::-webkit-scrollbar-thumb:hover {
        filter: brightness(1.1);
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
        .navbar-brand {
          font-size: 1.5rem;
        }

        .nav-link {
          padding: 0.5rem 0.8rem;
        }

        section {
          padding: 30px;
        }

        .card {
          margin-bottom: 20px;
        }

        .book-cover {
          height: 180px;
        }

        .input-group.rounded-pill .form-control,
        .input-group.rounded-pill .form-select:not(.modern-unique),
        .btn-primary {
          padding: 0.6rem 1.2rem;
          font-size: 0.9rem;
        }

        .theme-switch-wrapper {
          margin-left: 0;
          margin-top: 10px;
          justify-content: center;
        }

        /* Adjust for custom select on small screens */
        .custom-select-wrapper {
          width: 100%;
        }
      }
    </style>
  </head>

  <body class="dark-theme">
    <div class="cursor-light-trail"></div>
    <nav class="navbar navbar-expand-lg glass-effect">
      <div class="container-fluid">
        <a class="navbar-brand d-flex align-items-center" href="#">
          <i class="bi bi-book-half me-2"></i> BookFinder 
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
          aria-controls="navbarNav"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto align-items-center">
            <li class="nav-item">
              <a
                class="nav-link active"
                aria-current="page"
                href="#search-section"
                ><i class="bi bi-search me-1"></i>Search Books</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#home-section"
                ><i class="bi bi-house-door-fill me-1"></i>Dashboard</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#library-section"
                ><i class="bi bi-collection-fill me-1"></i>My Library</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#wishlist-section"
                ><i class="bi bi-bookmark-heart-fill me-1"></i>Wishlist</a
              >
            </li>
            <li class="nav-item theme-switch-wrapper">
              <i class="bi bi-moon-fill active" id="moonIcon"></i>
              <label class="theme-switch" for="checkbox">
                <input
                  type="checkbox"
                  id="checkbox"
                  aria-label="Toggle light and dark mode"
                />
                <div class="slider round"></div>
              </label>
              <i class="bi bi-sun-fill" id="sunIcon"></i>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <main class="container-fluid mt-5 pt-5">
      <section id="search-section" class="py-5 mb-4 glass-effect">
        <h2 class="text-center mb-4 display-5 fw-bold classy-glow">
          Discover Your Next Literary Journey
        </h2>
        <div
          class="input-group mb-4 glass-effect rounded-pill overflow-hidden"
          style="border: none"
        >
          <input
            type="text"
            class="form-control form-control-lg border-0 ps-4"
            id="searchInput"
            placeholder="Search by title or author..."
          />
          <select
            class="form-select border-0"
            id="filterCategory"
            style="max-width: 150px"
          >
            <option value="all">All Genres</option>
            <option value="fiction">Fiction</option>
            <option value="science">Science</option>
            <option value="history">History</option>
            <option value="biography">Biography</option>
            <option value="fantasy">Fantasy</option>
            <option value="thriller">Thriller</option>
            <option value="romance">Romance</option>
            <option value="business">Business</option>
            <option value="technology">Technology</option>
            <option value="health">Health</option>
            <option value="art">Art</option>
            <option value="philosophy">Philosophy</option>
          </select>
          <select
            class="form-select border-0"
            id="sortBy"
            style="max-width: 120px"
          >
            <option value="relevance">Relevance</option>
            <option value="newest">Newest</option>
          </select>
          <button
            class="btn btn-primary btn-lg px-4"
            type="button"
            id="searchButton"
          >
            <i class="bi bi-search me-2"></i>Search
          </button>
        </div>

        <div class="text-center d-none" id="loadingSpinner">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2 text-muted">Awaiting the arrival of new titles...</p>
        </div>

        <div
          id="personalizedRecommendation"
          class="mb-5 p-4 glass-effect d-none"
        >
          <h3 class="classy-glow">ðŸŒŸ Personalized Reading Spark ðŸŒŸ</h3>
          <p class="text-muted" id="personalizationMessage"></p>
          <div id="recommendedBook" class="row align-items-center"></div>
        </div>

        <h3 class="mt-5 mb-3 classy-glow">Curated Selections</h3>
        <div
          id="resultsContainer"
          class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4"
        ></div>
      </section>

      <section id="home-section" class="py-5 glass-effect mb-4 text-center">
        <h1 class="display-4 fw-bold mb-3 classy-glow">
          Your Reading Sanctuary
        </h1>
        <p class="lead text-muted">
          A quiet corner for your literary pursuits and progress.
        </p>
        <div class="row text-center mt-4">
          <div class="col-md-4 mb-3">
            <div class="card p-3 glass-effect h-100">
              <div class="card-body">
                <i
                  class="bi bi-book-fill display-4 text-primary classy-glow"
                ></i>
                <h5 class="card-title mt-3 classy-glow">Total Volumes</h5>
                <p class="card-text fs-4 fw-bold" id="totalBooks">0</p>
              </div>
            </div>
          </div>
          <div class="col-md-4 mb-3">
            <div class="card p-3 glass-effect h-100">
              <div class="card-body">
                <i
                  class="bi bi-journal-bookmark-fill display-4 text-success classy-glow"
                ></i>
                <h5 class="card-title mt-3 classy-glow">Currently Engaging</h5>
                <p class="card-text fs-4 fw-bold" id="readingNow">0</p>
              </div>
            </div>
          </div>
          <div class="col-md-4 mb-3">
            <div class="card p-3 glass-effect h-100">
              <div class="card-body">
                <i
                  class="bi bi-heart-fill display-4 text-danger classy-glow"
                ></i>
                <h5 class="card-title mt-3 classy-glow">Desired Reads</h5>
                <p class="card-text fs-4 fw-bold" id="wishlist">0</p>
              </div>
            </div>
          </div>
        </div>
        <div class="mt-5">
          <h3 class="classy-glow mb-3">Your Reading Journey Progress</h3>
          <div class="gamified-progress-bar">
            <div
              class="progress-fill"
              id="overallReadingProgress"
              style="width: 0%"
            ></div>
          </div>
          <p class="text-muted mt-2">
            <span id="overallProgressText">0</span>% of your library completed!
          </p>
          <div
            id="achievementPopup"
            class="alert alert-success d-none mt-3"
            role="alert"
          >
            <i class="bi bi-award-fill me-2"></i> **Achievement Unlocked!**
            <span id="achievementMessage"></span>
          </div>
        </div>
      </section>

      <section id="library-section" class="py-5 glass-effect mb-4">
        <h2 class="text-center mb-4 display-5 fw-bold classy-glow">
          Your Personal Collection
        </h2>
        <div class="d-flex justify-content-end mb-3">
          <div class="input-group w-auto glass-effect" style="border: none">
            <div class="custom-select-wrapper position-relative">
              <i class="bi bi-funnel custom-icon"></i>
              <select class="form-select stylish-select" id="libraryFilter">
                <option value="all">All Books</option>
                <option value="reading">Reading Now</option>
                <option value="completed">Completed</option>
              </select>
            </div>
          </div>
        </div>
        <div
          id="libraryContainer"
          class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4"
        ></div>
        <p id="noLibraryBooks" class="text-center text-muted mt-4 d-none">
          Your collection awaits new additions. Discover them above!
        </p>
      </section>

      <section id="wishlist-section" class="py-5 glass-effect">
        <h2 class="text-center mb-4 display-5 fw-bold classy-glow">
          Future Journeys
        </h2>
        <div
          id="wishlistContainer"
          class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4"
        ></div>
        <p id="noWishlistBooks" class="text-center text-muted mt-4 d-none">
          Your list of desired reads is empty. What will you explore next?
        </p>
      </section>
    </main>

    <div
      class="modal fade"
      id="bookModal"
      tabindex="-1"
      aria-labelledby="bookModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content glass-effect">
          <div class="modal-header border-0 pb-0">
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body p-4 pt-0">
            <div class="row">
              <div class="col-md-4 text-center">
                <img
                  id="modalBookCover"
                  src=""
                  alt="Book Cover"
                  class="img-fluid rounded shadow-sm mb-3"
                  style="max-height: 250px"
                />

                <div class="custom-select-wrapper mb-3">
                  <select class="form-select" id="readingStatus">
                    <option value="reading">Currently Reading</option>
                    <option value="completed">Finished Reading</option>
                    <option value="wishlist">Add to Wishlist</option>
                  </select>
                  <div class="select-arrow"></div>
                </div>

                <div id="progressInput" class="mb-3 d-none">
                  <label for="bookProgressRange" class="form-label text-muted"
                    >Progress: <span id="progressValue">0</span>%</label
                  >
                  <input
                    type="range"
                    class="form-range"
                    min="0"
                    max="100"
                    value="0"
                    id="bookProgressRange"
                  />
                </div>

                <div id="ratingInput" class="mb-3 d-none">
                  <label class="form-label text-muted"
                    >Your Esteemed Rating:</label
                  >
                  <div
                    id="starRatingContainer"
                    class="star-rating d-flex justify-content-center"
                  >
                    <i class="bi bi-star" data-rating="1"></i>
                    <i class="bi bi-star" data-rating="2"></i>
                    <i class="bi bi-star" data-rating="3"></i>
                    <i class="bi bi-star" data-rating="4"></i>
                    <i class="bi bi-star" data-rating="5"></i>
                  </div>
                  <input type="hidden" id="bookRating" value="0" />
                </div>

                <button class="btn btn-primary w-100" id="saveToLibrary">
                  Refine & Add to Shelf
                </button>
              </div>
              <div class="col-md-8">
                <h3
                  class="modal-title mb-2 fw-bold classy-glow"
                  id="modalBookTitle"
                ></h3>
                <p class="text-muted mb-2">
                  <i class="bi bi-person-fill"></i>
                  <span id="modalBookAuthors"></span>
                </p>
                <p class="text-muted mb-2">
                  <i class="bi bi-tag-fill"></i>
                  <span id="modalBookCategory"></span>
                </p>
                <p class="text-muted mb-4">
                  <i class="bi bi-file-earmark-text-fill"></i>
                  <span id="modalBookPages"></span>
                </p>
                <p class="text-secondary" id="modalBookDescription"></p>
                <a
                  id="modalPreviewLink"
                  href="#"
                  target="_blank"
                  class="btn btn-outline-secondary btn-sm mt-3"
                  ><i class="bi bi-book-reader me-1"></i>Glimpse Preview</a
                >
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Constants
      const GOOGLE_BOOKS_API = "https://www.googleapis.com/books/v1/volumes";
      const MAX_RESULTS = 20;

      // State Management
      let state = {
        library: [],
        wishlist: [],
        searchResults: [],
        currentBook: null, // The book currently being viewed/edited in the modal
        currentTheme: "dark", // Default theme
        userActivity: {
          // For simulated AI personalization
          lastSearchQuery: "",
          mostViewedCategory: "",
          searchCount: 0,
          libraryAddCount: 0,
        },
      };

      // Theme Toggle Elements
      const themeToggle = document.getElementById("checkbox");
      const moonIcon = document.getElementById("moonIcon");
      const sunIcon = document.getElementById("sunIcon");
      const body = document.body;
      const cursorLightTrail = document.querySelector(".cursor-light-trail");

      // Load saved data and theme from localStorage
      function loadSavedData() {
        const savedLibrary = localStorage.getItem("bookshelf_library");
        const savedWishlist = localStorage.getItem("bookshelf_wishlist");
        const savedTheme = localStorage.getItem("bookshelf_theme");
        const savedUserActivity = localStorage.getItem(
          "bookshelf_user_activity"
        );

        if (savedLibrary) state.library = JSON.parse(savedLibrary);
        if (savedWishlist) state.wishlist = JSON.parse(savedWishlist);
        if (savedUserActivity)
          state.userActivity = JSON.parse(savedUserActivity);

        if (savedTheme) {
          state.currentTheme = savedTheme;
          applyTheme(savedTheme);
          themeToggle.checked = savedTheme === "light"; // Set toggle state
        } else {
          applyTheme(state.currentTheme); // Apply default dark theme
        }

        updateStats();
        renderLibrary();
        renderWishlist();
        updateEmptyMessages();
        updateOverallReadingProgress();
        displayPersonalizedRecommendation(); // Display on load
      }

      // Save data and theme to localStorage
      function saveData() {
        localStorage.setItem(
          "bookshelf_library",
          JSON.stringify(state.library)
        );
        localStorage.setItem(
          "bookshelf_wishlist",
          JSON.stringify(state.wishlist)
        );
        localStorage.setItem("bookshelf_theme", state.currentTheme);
        localStorage.setItem(
          "bookshelf_user_activity",
          JSON.stringify(state.userActivity)
        );
      }

      // Apply Theme
      function applyTheme(theme) {
        body.classList.remove("light-theme", "dark-theme");
        body.classList.add(theme + "-theme");

        // Update icon active state
        if (theme === "dark") {
          moonIcon.classList.add("active");
          sunIcon.classList.remove("active");
        } else {
          moonIcon.classList.remove("active");
          sunIcon.classList.add("active");
        }
      }

      // Search Books
      async function searchBooks(
        query,
        category = "all",
        sortBy = "relevance"
      ) {
        const spinner = document.getElementById("loadingSpinner");
        spinner.classList.remove("d-none");
        const resultsContainer = document.getElementById("resultsContainer");
        resultsContainer.innerHTML = ""; 
        
        state.userActivity.lastSearchQuery = query;
        state.userActivity.searchCount++;
        if (category !== "all") {
          state.userActivity.mostViewedCategory = category;
        }
        saveData();

        try {
          let url = `${GOOGLE_BOOKS_API}?q=${encodeURIComponent(query)}`;

          if (category !== "all") {
            url += `+subject:${category}`;
          }

          url += `&orderBy=${sortBy}&maxResults=${MAX_RESULTS}`;

          const response = await fetch(url);
          const data = await response.json();

          state.searchResults = data.items?.map(formatBookData) || [];
          renderSearchResults();
          if (state.searchResults.length === 0) {
            resultsContainer.innerHTML = `<p class="text-center text-muted mt-4">No results found for "${query}". Perhaps a different title?</p>`;
          }
        } catch (error) {
          console.error("Error searching books:", error);
          showAlert(
            "Error searching for books. The cosmos might be busy. Please try again.",
            "danger"
          );
        } finally {
          spinner.classList.add("d-none");
        }
      }
      
      function formatBookData(book) {
        const volumeInfo = book.volumeInfo;
        return {
          id: book.id,
          title: volumeInfo.title || "Untitled Volume",
          authors: volumeInfo.authors || ["Anonymous Scholar"],
          description:
            volumeInfo.description ||
            "A mysterious tome with no readily available description.",
          categories: volumeInfo.categories || ["Unclassified Knowledge"],
          pageCount: volumeInfo.pageCount || null,
          publishedDate: volumeInfo.publishedDate,
          thumbnail:
            volumeInfo.imageLinks?.thumbnail ||
            "https://via.placeholder.com/128x192?text=No+Cover",
          previewLink: volumeInfo.previewLink || "#",
          status: "wishlist", 
          progress: 0,
          rating: 0,
        };
      }
      
      function renderSearchResults() {
        const container = document.getElementById("resultsContainer");
        container.innerHTML = state.searchResults
          .map((book) => createBookCard(book, "search"))
          .join("");
      }

      function renderLibrary() {
        const container = document.getElementById("libraryContainer");
        const filter = document.getElementById("libraryFilter").value;

        let books = state.library;
        if (filter !== "all") {
          books = books.filter((book) => book.status === filter);
        }

        container.innerHTML = books
          .map((book) => createBookCard(book, "library"))
          .join("");
        updateEmptyMessages();
      }

      function renderWishlist() {
        const container = document.getElementById("wishlistContainer");
        container.innerHTML = state.wishlist
          .map((book) => createBookCard(book, "wishlist"))
          .join("");
        updateEmptyMessages();
      }

      function createBookCard(book, type) {
        const isLibrary = type === "library";
        
        
        let extraInfoHtml = "";
        if (isLibrary && book.status === "reading") {
          extraInfoHtml = `
                    <div class="gamified-progress-bar mt-3">
                        <div
                            class="progress-fill"
                            style="width: ${book.progress || 0}%"
                            aria-valuenow="${book.progress || 0}"
                            aria-valuemin="0"
                            aria-valuemax="100"
                        ></div>
                    </div>
                    <small class="text-muted text-end d-block mt-1">${
                      book.progress || 0
                    }% Immersed</small>
                `;
        } else if (
          isLibrary &&
          book.status === "completed" &&
          book.rating > 0
        ) {
          const starsHtml = Array(5)
            .fill()
            .map(
              (_, i) =>
                `<i class="bi ${
                  i < book.rating ? "bi-star-fill" : "bi-star"
                }" style="color: ${
                  i < book.rating
                    ? "var(--accent-color)"
                    : "var(--star-unfilled-color)"
                };"></i>`
            )
            .join("");
          extraInfoHtml = `<div class="star-rating mt-3 text-center">${starsHtml}</div>`;
        }

        return `
                <div class="col-md-3">
                    <div class="card book-card h-100 glass-effect">
                        ${
                          isLibrary
                            ? `
                            <div class="reading-status">
                                <span class="badge bg-${
                                  book.status === "completed"
                                    ? "success"
                                    : "primary"
                                }">
                                    ${
                                      book.status === "completed"
                                        ? "Completed"
                                        : "Reading"
                                    }
                                </span>
                            </div>
                        `
                            : ""
                        }
                        <img src="${
                          book.thumbnail
                        }" class="card-img-top book-cover p-2" alt="${
          book.title
        }">
                        <div class="card-body">
                            <h5 class="card-title book-title">${book.title}</h5>
                            <p class="card-text book-authors text-muted">${book.authors.join(
                              ", "
                            )}</p>
                            ${extraInfoHtml}
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <button
                                    onclick="showBookDetails('${book.id}')"
                                    class="btn btn-outline-primary btn-sm"
                                >
                                    Details
                                </button>
                                <button
                                    onclick="removeBook('${
                                      book.id
                                    }', '${type}')"
                                    class="btn btn-outline-danger btn-sm"
                                >
                                    Remove
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
      }

      // Book Management
      function showBookDetails(bookId) {
        let book = findBook(bookId);

        // If book is already in library, use the library's version (with progress/rating)
        const libraryBook = state.library.find((b) => b.id === bookId);
        if (libraryBook) {
          book = libraryBook;
        }

        if (!book) return;

        state.currentBook = book;

        document.getElementById("modalBookCover").src = book.thumbnail;
        document.getElementById("modalBookTitle").textContent = book.title;
        document.getElementById("modalBookAuthors").textContent =
          book.authors.join(", ");
        document.getElementById("modalBookCategory").textContent =
          book.categories[0];
        document.getElementById("modalBookPages").textContent = `${
          book.pageCount || "?"
        } pages`;
        document.getElementById("modalBookDescription").textContent =
          book.description;

        const modalPreviewLink = document.getElementById("modalPreviewLink");
        if (book.previewLink && book.previewLink !== "#") {
          // Ensure it's a valid link
          modalPreviewLink.href = book.previewLink;
          modalPreviewLink.classList.remove("d-none");
        } else {
          modalPreviewLink.classList.add("d-none");
        }

        const readingStatusSelect = document.getElementById("readingStatus");
        const progressInputDiv = document.getElementById("progressInput");
        const ratingInputDiv = document.getElementById("ratingInput");
        const bookProgressRange = document.getElementById("bookProgressRange");
        const progressValueSpan = document.getElementById("progressValue");
        const starRatingContainer = document.getElementById(
          "starRatingContainer"
        );
        const bookRatingInput = document.getElementById("bookRating");
        const saveButton = document.getElementById("saveToLibrary");

        // Reset modal inputs to current book's data or defaults
        readingStatusSelect.value = book.status || "reading";
        bookProgressRange.value = book.progress || 0;
        progressValueSpan.textContent = book.progress || 0;
        bookRatingInput.value = book.rating || 0;
        updateStarRatingUI(book.rating || 0);

        // Show/hide progress/rating fields based on book status
        const updateModalFields = () => {
          const currentStatus = readingStatusSelect.value;
          if (currentStatus === "reading") {
            progressInputDiv.classList.remove("d-none");
            ratingInputDiv.classList.add("d-none");
            saveButton.textContent = "Update Progress / Add to Shelf";
          } else if (currentStatus === "completed") {
            progressInputDiv.classList.add("d-none");
            ratingInputDiv.classList.remove("d-none");
            saveButton.textContent = "Set Rating / Add to Shelf";
          } else {
            // wishlist
            progressInputDiv.classList.add("d-none");
            ratingInputDiv.classList.add("d-none");
            saveButton.textContent = "Add to Wishlist";
          }
        };

        readingStatusSelect.onchange = updateModalFields; // Update fields when status changes
        updateModalFields(); // Call on load to set initial state

        // Progress slider update
        bookProgressRange.oninput = () => {
          progressValueSpan.textContent = bookProgressRange.value;
        };

        // Star rating click handler
        starRatingContainer.onclick = (e) => {
          const clickedStar = e.target.closest(".bi-star, .bi-star-fill");
          if (clickedStar) {
            const rating = parseInt(clickedStar.dataset.rating);
            bookRatingInput.value = rating;
            updateStarRatingUI(rating);
          }
        };

        new bootstrap.Modal(document.getElementById("bookModal")).show();
      }

      function updateStarRatingUI(rating) {
        const stars = document.querySelectorAll("#starRatingContainer .bi");
        stars.forEach((star, index) => {
          if (index < rating) {
            star.classList.remove("bi-star");
            star.classList.add("bi-star-fill");
            star.style.color = "var(--accent-color)"; // Filled star color
          } else {
            star.classList.remove("bi-star-fill");
            star.classList.add("bi-star");
            star.style.color = "var(--star-unfilled-color)"; // Unfilled star color - more subtle
          }
        });
      }

      function findBook(bookId) {
        return (
          state.searchResults.find((b) => b.id === bookId) ||
          state.library.find((b) => b.id === bookId) ||
          state.wishlist.find((b) => b.id === bookId)
        );
      }

      function saveToLibrary() {
        if (!state.currentBook) return;

        const newStatus = document.getElementById("readingStatus").value;
        const progress = parseInt(
          document.getElementById("bookProgressRange").value
        );
        const rating = parseInt(document.getElementById("bookRating").value);

        let bookToSave = { ...state.currentBook }; // Create a copy

        // Store original status to check for completion
        const originalStatus = state.library.find(
          (b) => b.id === bookToSave.id
        )?.status;

        // Update properties based on current modal inputs
        bookToSave.status = newStatus;
        bookToSave.progress = newStatus === "reading" ? progress : 0; // Only save progress if 'reading'
        bookToSave.rating = newStatus === "completed" ? rating : 0; // Only save rating if 'completed'

        // Check if book already exists in library or wishlist
        const existingLibraryIndex = state.library.findIndex(
          (b) => b.id === bookToSave.id
        );
        const existingWishlistIndex = state.wishlist.findIndex(
          (b) => b.id === bookToSave.id
        );

        // Remove from existing lists first to ensure clean transition
        if (existingLibraryIndex !== -1) {
          state.library.splice(existingLibraryIndex, 1);
        }
        if (existingWishlistIndex !== -1) {
          state.wishlist.splice(existingWishlistIndex, 1);
        }

        // Add to the appropriate list based on new status
        if (newStatus === "wishlist") {
          state.wishlist.push(bookToSave);
        } else {
          // 'reading' or 'completed'
          state.library.push(bookToSave);
          state.userActivity.libraryAddCount++; // Track additions
        }

        saveData();
        updateStats();
        renderLibrary();
        renderWishlist();
        updateEmptyMessages();
        updateOverallReadingProgress(); // Update overall progress

        // Trigger achievement check
        if (newStatus === "completed" && originalStatus !== "completed") {
          checkAchievements();
        }

        // Animate button and show alert
        const saveButton = document.getElementById("saveToLibrary");
        saveButton.classList.add("achievement-spark");
        setTimeout(() => {
          saveButton.classList.remove("achievement-spark");
        }, 700); // Match animation duration

        bootstrap.Modal.getInstance(
          document.getElementById("bookModal")
        ).hide();
        showAlert("Book elegantly updated!", "success");
      }

      function removeBook(bookId, type) {
        if (type === "library") {
          state.library = state.library.filter((book) => book.id !== bookId);
        } else if (type === "wishlist") {
          state.wishlist = state.wishlist.filter((book) => book.id !== bookId);
        }

        saveData();
        updateStats();
        renderLibrary();
        renderWishlist();
        updateEmptyMessages();
        updateOverallReadingProgress(); // Update overall progress

        showAlert("Volume gracefully removed.", "success");
      }

      function updateStats() {
        document.getElementById("totalBooks").textContent =
          state.library.length;
        document.getElementById("readingNow").textContent =
          state.library.filter((book) => book.status === "reading").length;
        document.getElementById("wishlist").textContent = state.wishlist.length;
      }

      function updateOverallReadingProgress() {
        const completedBooks = state.library.filter(
          (book) => book.status === "completed"
        ).length;
        const totalBooks = state.library.length;
        let progress = 0;
        if (totalBooks > 0) {
          progress = Math.round((completedBooks / totalBooks) * 100);
        }
        document.getElementById(
          "overallReadingProgress"
        ).style.width = `${progress}%`;
        document.getElementById("overallProgressText").textContent = progress;
      }

      // Gamified Achievements (Simulated)
      function checkAchievements() {
        const completedBooks = state.library.filter(
          (book) => book.status === "completed"
        ).length;
        let achievementMessage = "";

        if (
          completedBooks === 1 &&
          !localStorage.getItem("achievement_first_book")
        ) {
          achievementMessage =
            "First Read Complete! A journey of a thousand pages begins with a single word.";
          localStorage.setItem("achievement_first_book", true);
        } else if (
          completedBooks === 5 &&
          !localStorage.getItem("achievement_five_books")
        ) {
          achievementMessage =
            "Avid Reader! 5 books conquered â€“ your mind is expanding!";
          localStorage.setItem("achievement_five_books", true);
        } else if (
          completedBooks === 10 &&
          !localStorage.getItem("achievement_ten_books")
        ) {
          achievementMessage =
            "Literary Luminary! 10 books down, countless worlds explored!";
          localStorage.setItem("achievement_ten_books", true);
        }

        if (achievementMessage) {
          showAchievement(achievementMessage);
        }
      }

      function showAchievement(message) {
        const achievementPopup = document.getElementById("achievementPopup");
        document.getElementById("achievementMessage").textContent = message;
        achievementPopup.classList.remove("d-none");
        setTimeout(() => {
          achievementPopup.classList.add("d-none");
        }, 5000); // Hide after 5 seconds
      }

      // Simulated AI: Personalized Recommendations
      async function displayPersonalizedRecommendation() {
        const recommendationContainer = document.getElementById(
          "personalizedRecommendation"
        );
        const personalizationMessage = document.getElementById(
          "personalizationMessage"
        );
        const recommendedBookDiv = document.getElementById("recommendedBook");
        recommendedBookDiv.innerHTML = ""; // Clear previous

        let recommendedQuery = "";
        let message = "";

        // Rule 1: Based on most viewed category if available
        if (
          state.userActivity.mostViewedCategory &&
          state.userActivity.searchCount > 2
        ) {
          recommendedQuery = `subject:${state.userActivity.mostViewedCategory}`;
          message = `Based on your recent explorations in **${state.userActivity.mostViewedCategory}**, here's a new spark!`;
        }
        // Rule 2: If no specific category, based on last search
        else if (
          state.userActivity.lastSearchQuery &&
          state.userActivity.searchCount > 0
        ) {
          recommendedQuery = state.userActivity.lastSearchQuery;
          message = `Inspired by your last search for "${state.userActivity.lastSearchQuery}", discover something similar!`;
        }
        // Rule 3: If new user or no clear pattern, suggest a popular genre
        else {
          const genres = ["fiction", "fantasy", "science", "history"];
          recommendedQuery = `subject:${
            genres[Math.floor(Math.random() * genres.length)]
          }`;
          message = `Welcome to your reading sanctuary! Here's a popular pick to get you started.`;
        }

        if (recommendedQuery) {
          try {
            const response = await fetch(
              `${GOOGLE_BOOKS_API}?q=${encodeURIComponent(
                recommendedQuery
              )}&maxResults=1&orderBy=relevance`
            );
            const data = await response.json();
            const book = data.items?.[0] ? formatBookData(data.items[0]) : null;

            if (book) {
              // Ensure the recommended book is added to searchResults so showBookDetails can find it
              const existingInSearchResults = state.searchResults.findIndex(
                (b) => b.id === book.id
              );
              if (existingInSearchResults === -1) {
                state.searchResults.push(book); // Add it if not already there
              }

              personalizationMessage.textContent = message;
              recommendedBookDiv.innerHTML = `
                            <div class="col-md-3 text-center">
                                <img src="${book.thumbnail}" alt="${
                book.title
              }" class="img-fluid rounded shadow-sm" style="max-height: 150px;">
                            </div>
                            <div class="col-md-9">
                                <h4 class="classy-glow">${book.title}</h4>
                                <p class="text-muted">${book.authors.join(
                                  ", "
                                )}</p>
                                <p class="text-secondary">${book.description.substring(
                                  0,
                                  150
                                )}...</p>
                                <button onclick="showBookDetails('${
                                  book.id
                                }')" class="btn btn-outline-primary btn-sm">View Details</button>
                            </div>
                        `;
              recommendationContainer.classList.remove("d-none");
            } else {
              recommendationContainer.classList.add("d-none"); // Hide if no recommendation found
            }
          } catch (error) {
            console.error("Error fetching recommendation:", error);
            recommendationContainer.classList.add("d-none");
          }
        } else {
          recommendationContainer.classList.add("d-none");
        }
      }

      // Utility Functions
      function showAlert(message, type) {
        const alertContainer = document.createElement("div");
        alertContainer.className = `alert-container position-fixed top-0 end-0 m-3`;
        alertContainer.style.zIndex = "1060"; // Higher than modal
        alertContainer.style.maxWidth = "300px";

        const alert = document.createElement("div");
        alert.className = `alert alert-${type} alert-dismissible fade show`;
        alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
        alertContainer.appendChild(alert);
        document.body.appendChild(alertContainer);

        setTimeout(() => {
          alert.classList.remove("show");
          alert.classList.add("hide");
          alert.addEventListener("transitionend", () =>
            alertContainer.remove()
          );
        }, 3000);
      }

      function updateEmptyMessages() {
        const noLibraryBooks = document.getElementById("noLibraryBooks");
        const noWishlistBooks = document.getElementById("noWishlistBooks");

        // Hide/show based on filtered results
        const filteredLibraryBooks = state.library.filter((book) => {
          const filter = document.getElementById("libraryFilter").value;
          return filter === "all" || book.status === filter;
        });

        if (filteredLibraryBooks.length === 0) {
          noLibraryBooks.classList.remove("d-none");
        } else {
          noLibraryBooks.classList.add("d-none");
        }

        if (state.wishlist.length === 0) {
          noWishlistBooks.classList.remove("d-none");
        } else {
          noWishlistBooks.classList.add("d-none");
        }
      }

      // Event Listeners
      document.getElementById("searchButton").addEventListener("click", () => {
        const query = document.getElementById("searchInput").value;
        const category = document.getElementById("filterCategory").value;
        const sortBy = document.getElementById("sortBy").value;
        if (query.trim()) {
          searchBooks(query, category, sortBy);
        } else {
          showAlert("Please articulate your quest for knowledge.", "warning");
        }
      });

      document
        .getElementById("searchInput")
        .addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            document.getElementById("searchButton").click();
          }
        });

      document
        .getElementById("saveToLibrary")
        .addEventListener("click", saveToLibrary);

      document
        .getElementById("libraryFilter")
        .addEventListener("change", renderLibrary);

      // Theme Toggle Event Listener
      themeToggle.addEventListener("change", () => {
        if (themeToggle.checked) {
          state.currentTheme = "light";
        } else {
          state.currentTheme = "dark";
        }
        applyTheme(state.currentTheme);
        saveData(); // Save theme preference
      });

      // Custom Cursor Light Trail
      document.addEventListener("mousemove", (e) => {
        cursorLightTrail.style.left = `${e.clientX}px`;
        cursorLightTrail.style.top = `${e.clientY}px`;
      });

      // Initialize
      document.addEventListener("DOMContentLoaded", () => {
        loadSavedData();
        updateEmptyMessages();
      });
    </script>
  </body>
</html>
